<html>

<head>
    <H1> Faust dynamically generated WebAudio node </H1>
</head>

<body>
    <P> OSC freq:
        <input type="range" oninput="changeFreq(event) " min="20" max="2000" value="1000" step="10" />
    <P> OSC volume:
        <input type="range" oninput="changeVolume(event) " min="-96" max="1" value="-20" step="0.1" />

        <!-- Load 'libfaust' library and wrapper code -->
        <script src="libfaust-wasm.js"></script>
        <!-- Load the Faust JS library -->
        <script src="FaustLibrary.js"></script>

        <script>

            function workletAvailable() {
                if (typeof (OfflineAudioContext) === "undefined") return false;
                var context = new OfflineAudioContext(1, 1, 44100);
                return context.audioWorklet && typeof context.audioWorklet.addModule === 'function';
            }

            if (typeof (WebAssembly) === "undefined" || !workletAvailable()) {
                alert("WebAssembly or AudioWorklet is not supported in this browser !")
            }

            // Init audio context
            var isWebKitAudio = (typeof (webkitAudioContext) !== "undefined");
            var audio_context = (isWebKitAudio) ? new webkitAudioContext({ latencyHint: 0.00001 }) : new AudioContext({ latencyHint: 0.00001 });
            audio_context.destination.channelInterpretation = "discrete";

            var dsp_code = "import(\"stdfaust.lib\"); vol = hslider(\"volume [unit:dB]\", 0, -96, 0, 0.1) : ba.db2linear : si.smoo; freq = hslider(\"freq [unit:Hz]\", 1000, 20, 5000, 1); process = vgroup(\"Oscillator\", os.osc(freq) * vol) <:(_,_);";
            var osc_dsp = null;

            // Slider handler to change the 'osc' frequency
            function changeFreq(event) {
                var val = event.target.value;
                val = parseFloat(val);
                console.log(val);
                osc_dsp.setParamValue("/Oscillator/freq", val);
            }

            // Slider handler to change the 'osc' volume
            function changeVolume(event) {
                var val = event.target.value;
                val = parseFloat(val);
                console.log(val);
                osc_dsp.setParamValue("/Oscillator/volume", val);
            }

            // Load handler which call 'startosc' when 'libfaust-wasm.js' is properly loaded
            FaustModule().then((module) => { startosc(module); });

            async function startosc(module) {

                // Dynamically create the Faust generated node from explicit DSP source in 'dsp_code'
                osc_dsp = await Faust.compileAudioNode(audio_context, module, dsp_code, null, 0);

                // Print DSP JSON																				
                console.log(osc_dsp.getJSON());
                // Print paths to be used with 'setParamValue'
                console.log(osc_dsp.getParams());
                // Connect it to output as a regular WebAudio node
                osc_dsp.connect(audio_context.destination);
            }

            // To activate audio on iOS
            window.addEventListener('touchstart', function () {
                if (audio_context.state !== "suspended") return;
                // create empty buffer
                var buffer = audio_context.createBuffer(1, 1, 22050);
                var source = audio_context.createBufferSource();
                source.buffer = buffer;

                // connect to output (your speakers)
                source.connect(audio_context.destination);

                // play the file
                source.start();

                audio_context.resume().then(() => console.log("Audio resumed"));
            }, false);

            // On desktop
            window.addEventListener("mousedown", () => {
                if (audio_context.state !== "suspended") return;
                audio_context.resume().then(() => console.log("Audio resumed"))
            });

        </script>

</body>

</html>